Got it üëç ‚Äî let‚Äôs make you a **clear developer‚Äôs manual** so you (or anyone else) can spin this environment up and down without friction. I‚Äôll write it as if it‚Äôs part of your repo documentation.

---

# üåê Dev Environment Manual (PHP + HTTPS via Caddy)

This manual explains how to **run, stop, and troubleshoot** the local dev environment for your project at
`D:\domalecs-os\clix5\OSbench`.

---

## 1. üì¶ Prerequisites

Before you start:

* **PHP** installed and in your PATH
  Test:

  ```powershell
  php -v
  ```
* **Caddy** installed (via Chocolatey or manually)
  Test:

  ```powershell
  caddy version
  ```
* **PowerShell** (run as Administrator when first editing `hosts`).

---

## 2. üöÄ Start the Environment

From PowerShell:

```powershell
Set-Location D:\domalecs-os\clix5\OSbench
.\run-https-dev.ps1 -Start -Open -SiteHost dev.local -PhpPort 8000
```

* **PHP** will start on: `http://127.0.0.1:8000`
* **Caddy** will start on: `https://dev.local/`
* Logs are written to: `https-dev-logs\`

üëâ First run as **Administrator** to allow `dev.local` ‚Üí `127.0.0.1` mapping and to trust Caddy‚Äôs local TLS cert.

---

## 3. üß™ Check the Setup

* Visit:

  * **Diagnostics:** [https://dev.local/diagnostics.php](https://dev.local/diagnostics.php)
    Should show `APP_IS_HTTPS=true`.
  * **Your app:** [https://dev.local/](https://dev.local/)

* Inspect logs if something fails:

  ```powershell
  Get-Content .\https-dev-logs\php.err.txt -Tail 50
  Get-Content .\https-dev-logs\caddy.err.txt -Tail 50
  ```

---

## 4. üõë Stop the Environment

If started via script (background processes):

```powershell
.\run-https-dev.ps1 -Stop
```

This kills both **PHP** and **Caddy** using PID files.

If you manually ran `caddy run ...` in the foreground, stop it with:

```
Ctrl + C
```

---

## 5. üîß Common Issues

### "Caddy failed to start"

* Check if port **443** is already in use:

  ```powershell
  netstat -ano | findstr ":443" | findstr LISTENING
  ```
* If occupied, change port in `Caddyfile` to `8443`:

  ```
  dev.local:8443 {
      ...
  }
  ```

  Then access [https://dev.local:8443/](https://dev.local:8443/).

---

### "Not secure" browser warning

* Ensure the cert from Caddy is trusted (Caddy usually installs automatically).
* Clear browser HSTS cache if it persists.

---

### Changing site host

* By default, `dev.local` is mapped.
* You can start with `localhost` instead:

  ```powershell
  .\run-https-dev.ps1 -Start -SiteHost localhost -PhpPort 8000
  ```

---

## 6. üóÇ Directory Structure (dev-related)

```
OSbench/
‚îÇ
‚îú‚îÄ run-https-dev.ps1       # Script to start/stop environment
‚îú‚îÄ Caddyfile               # Auto-generated by script
‚îú‚îÄ https-dev-logs/         # PHP & Caddy logs
‚îú‚îÄ diagnostics.php         # Simple health check
‚îî‚îÄ (your PHP app files...)
```

---

## 7. üìù Workflow Summary

1. `.\run-https-dev.ps1 -Start -Open`
   ‚Üí Start PHP + Caddy with HTTPS.
2. Work on code, refresh [https://dev.local/](https://dev.local/).
3. Debug issues via logs.
4. `.\run-https-dev.ps1 -Stop` when done.

---

‚úÖ With this workflow, you get:

* HTTPS locally (with trusted certs)
* Clean separation of PHP (port 8000) and Caddy (port 443)
* Simple start/stop commands for repeatable dev sessions

---

Would you like me to also prepare this manual as a **`DEV-SETUP.md`** file, ready to drop into your repo?

---

Nice ‚Äî that screenshot looks right. The CSP violations are gone (the console shows only your own ‚Äú\[GOS:\*]‚Äù logs), which means the updated `security_bootstrap.php` is doing its job:

* Dev mode ‚Üí **no nonce in CSP**, inline/eval allowed, no browser complaints.
* HTTPS via Caddy, HSTS/COOP/optional COEP handled by the proxy.
* PHP is serving behind Caddy on 127.0.0.1:8000.

About the **‚ÄúSystem Error / An error occurred.‚Äù** on the page: that‚Äôs now an app-level issue (not headers/CSP). Here‚Äôs a quick triage checklist so you can pin it down fast:

### 1) Look for a failing request

* Open DevTools ‚Üí **Network** (keep ‚ÄúPreserve log‚Äù on).
* Click **Restart**.
* Filter by **Status >= 400** or **Type: xhr/fetch**.
* Click any failing row ‚Üí check **Response** and **Preview**.
  If it‚Äôs a PHP exception/notice, you‚Äôll see it here.

### 2) Check local logs

* PHP stdout/stderr from your launcher script:

  * `OSbench\https-dev-logs\php.err.txt`
  * `OSbench\https-dev-logs\php.out.txt`
* Caddy (usually quiet for app errors):

  * `OSbench\https-dev-logs\caddy.err.txt`
  * `OSbench\https-dev-logs\caddy.out.txt`

### 3) Ensure sessions & storage work

Common causes for ‚ÄúSystem Error‚Äù in auth/boot:

* **Sessions**: make sure PHP can write session files.

  * Check `session.save_path` in `php -i` or `phpinfo()`.
  * If it‚Äôs empty or unwritable, set e.g. in a local `php.ini`:

    ```
    session.save_path = "C:\Users\<you>\AppData\Local\Temp\phpsessions"
    ```

    (create the folder; restart dev.)
* **App data directories** (if your app writes to disk): confirm the paths exist and are writable by your user account.

### 4) Keep dev errors visible

You‚Äôre already in dev (console shows ‚ÄúDebug mode: enabled‚Äù), but to force it:

* In your environment (or via your launcher), set:

  * `APP_ENV=development`
  * `APP_DEBUG=1`
* Then reload. Any PHP errors should surface in the **Network response** or `php.err.txt`.

### 5) If you still see the error with no logs

* Add a quick guard near where you render ‚ÄúSystem Error‚Äù to also dump the underlying exception/message when `APP_DEBUG=1`.
* Verify your routes/rewrite: your Caddyfile is already rewriting ‚Äúnon-files‚Äù to `/index.php` and proxying `.php` files ‚Äî that part is correct.

### Helpful commands/reminders

* **Start** (from `OSbench`):

  ```
  .\run-https-dev.ps1 -Start -Open -SiteHost dev.local -PhpPort 8000
  ```
* **Stop**:

  ```
  .\run-https-dev.ps1 -Stop
  ```
* **Quick HTTPS probe** (PowerShell):

  ```
  curl.exe -k -I https://dev.local/
  ```
* **Open diagnostics**:

  ```
  https://dev.local/diagnostics.php
  ```

  It should show `APP_IS_PROD=false`, `APP_IS_HTTPS=true`.

### Using the CSP nonce in prod (recap)

In production builds/templates, wrap any inline code with the nonce:

```php
<script <?= security_csp_nonce() ? 'nonce="'.security_csp_nonce().'"' : '' ?>>
  // inline JS
</script>

<style <?= security_csp_nonce() ? 'nonce="'.security_csp_nonce().'"' : '' ?>>
  /* inline CSS */
</style>
```

* **Dev**: `security_csp_nonce()` returns empty ‚Üí attribute omitted ‚Üí inline allowed.
* **Prod**: it returns a value ‚Üí CSP requires it ‚Üí no violations.

If you share a snippet of the failing Network response (status + body) or the latest lines from `php.err.txt`, I can pinpoint the exact cause of that ‚ÄúSystem Error.‚Äù

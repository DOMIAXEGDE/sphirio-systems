# Genesis OS — Local HTTPS Dev Setup (PHP + Caddy on Windows)

This guide shows you how to run **Genesis OS** locally over **HTTPS** on Windows using:

* PHP’s built-in server for the app (HTTP on `127.0.0.1:8000`)
* **Caddy** as a local TLS reverse proxy (`https://dev.local` → PHP)

It matches the environment we just verified working (Diagnostics pane: ✅).

---

## Contents

* [Prerequisites](#prerequisites)
* [Files in this repo](#files-in-this-repo)
* [One-command start/stop](#one-command-startstop)
* [What the script does](#what-the-script-does)
* [Environment variables (security\_bootstrap.php)](#environment-variables-security_bootstrapphp)
* [Verifying it works](#verifying-it-works)
* [Troubleshooting](#troubleshooting)
* [Manual run (without the script)](#manual-run-without-the-script)
* [Clean up](#clean-up)

---

## Prerequisites

> Open **PowerShell** *as Administrator* for the first run (needed to edit `hosts` and allow Caddy to trust a local CA certificate).

* **PHP 8.1+** in `PATH`
  Check: `php -v`
* **Caddy** in `PATH` (via Chocolatey or manual install)
  Install with Chocolatey:

  ```powershell
  choco install caddy
  ```

  Check: `caddy version`
* Windows 10/11 with Edge/Chrome/Firefox (any modern browser)

---

## Files in this repo

```
OSbench/
├─ run-https-dev.ps1        # helper script to run/stop the dev stack
├─ Caddyfile                # generated by the script
├─ https-dev-logs/          # created by the script (PHP/Caddy logs)
├─ security_bootstrap.php   # app security & headers (dev-friendly)
└─ genesis-os.php           # your app entry point
```

> You don’t need to hand-edit `Caddyfile`; the script writes it for you.

---

## One-command start/stop

From the project root (`OSbench`):

### Start (recommended)

```powershell
# First run in an elevated PowerShell window
.\run-https-dev.ps1 -Start -Open -SiteHost dev.local -PhpPort 8000
```

* `-Open` will launch `https://dev.local/diagnostics.php`.
* If the script can’t edit `hosts` (not elevated), it **falls back to `localhost`** automatically.

### Stop

```powershell
.\run-https-dev.ps1 -Stop
```

### Optional flags

* `-Root "D:\path\to\OSbench"` – serve a different project path
* `-NoHeaders` – don’t add COOP/COEP/HSTS in Caddy (rarely needed)
* `-SiteHost localhost` – skip hosts edits and use `https://localhost/`

---

## What the script does

1. **Ensures hostname resolution**

   * Adds `dev.local` → `127.0.0.1` / `::1` to `C:\Windows\System32\drivers\etc\hosts` (first run, needs admin)
   * If that fails, uses `localhost` as a safe fallback

2. **Generates a `Caddyfile`** that:

   * Serves *static non-PHP* files directly (fast)
   * Proxies `*.php` and non-file routes to PHP (`/index.php`)
   * Adds **security headers** (HSTS, COOP/COEP) unless `-NoHeaders` used

3. **Starts**:

   * PHP: `php -S 127.0.0.1:8000 -t <root>`
   * Caddy: listens on `:443` and reverse-proxies to PHP

4. **Captures logs** in `https-dev-logs\`:

   * `php.out.txt`, `php.err.txt`, `caddy.out.txt`, `caddy.err.txt`

5. **Creates PID files** in `%TEMP%\https-dev-state\` so `-Stop` is clean.

---

## Environment variables (`security_bootstrap.php`)

The bootstrap auto-detects **development** when using local hosts (`*.local`, `localhost`, `127.0.0.1`, `::1`). You can override with env vars:

| Variable                   | Values                       | Default (Dev) | Default (Prod) | Notes                                         |
| -------------------------- | ---------------------------- | ------------: | -------------: | --------------------------------------------- |
| `APP_ENV`                  | `development` / `production` |          auto |           auto | Force if you need                             |
| `APP_DEBUG`                | `1`/`0`                      |           `1` |            `0` | Controls error display                        |
| `APP_HSTS_PRELOAD`         | `1`/`0`                      |           `0` |            `0` | Only for real domains                         |
| `APP_CSP_ALLOW_INLINE_DEV` | `1`/`0`                      |           `1` |            `0` | Allows inline/eval in dev to avoid CSP errors |
| `APP_COEP`                 | `1`/`0`                      |           `0` |            `0` | Enable only if you truly need COEP            |

> In **dev**, we keep CSP strict but permit inline/eval when `APP_CSP_ALLOW_INLINE_DEV=1` to make the UI load without console CSP errors.

---

## Verifying it works

After `-Start`:

1. **Check PHP port**

   ```powershell
   Test-NetConnection 127.0.0.1 -Port 8000
   ```

   `TcpTestSucceeded : True`

2. **Check vhost resolves**

   ```powershell
   ping dev.local
   ```

   Should reply from `::1` or `127.0.0.1`.

3. **Ask Caddy directly**

   ```powershell
   # Use curl.exe, not PowerShell's alias
   curl.exe -k -I https://dev.local/
   ```

   Expect `HTTP/1.1 200 OK` and `Strict-Transport-Security`, `Cross-Origin-Opener-Policy`, etc.

4. **Open the app**

   * `https://dev.local/diagnostics.php` – shows flags & environment
   * `https://dev.local/genesis-os.php` – Genesis OS boots; Diagnostics app shows all **OK** checks

---

## Troubleshooting

### “Caddy failed to start” / port 443 issues

* Check something else isn’t **listening** on 443:

  ```powershell
  netstat -ano | findstr ":443" | findstr LISTENING
  ```

  If a PID shows up, inspect it: `Get-Process -Id <PID>`

### Validate/format the Caddyfile (if you hand-edit)

```powershell
caddy validate --config .\Caddyfile --adapter caddyfile
caddy fmt --overwrite .\Caddyfile
```

### No HTTPS response yet?

* Certificates are auto-managed. On first run, Caddy creates a **local CA** and trusts it in Windows; you’ll see logs like:

  * `certificate obtained successfully {"identifier":"dev.local","issuer":"local"}`
* If you changed the hostname, re-run `-Start` as Admin once to let Caddy trust the new cert.

### PowerShell `curl` errors

Use `curl.exe` (the real curl) not the PS alias:

```powershell
curl.exe -k -I https://dev.local/
```

### Clear stubborn browser state (rare)

If browsers cached HSTS or old state, close them and clear network state/HSTS for the profile. The original `fix-local-ssl.ps1` has a `-PurgeBrowsers` option; or clear per-profile manually.

### Logs

Tail them live:

```powershell
Get-Content .\https-dev-logs\php.err.txt -Wait
Get-Content .\https-dev-logs\caddy.out.txt -Wait
```

---

## Manual run (without the script)

> Only if you prefer doing it by hand.

1. Map host (Admin PowerShell):

   ```powershell
   Add-Content "$env:WINDIR\System32\drivers\etc\hosts" "`n127.0.0.1`tdev.local`n::1`tdev.local"
   ```

2. Start PHP in the project root:

   ```powershell
   php -S 127.0.0.1:8000 -t .
   ```

3. Minimal `Caddyfile`:

   ```caddyfile
   dev.local {
       encode zstd gzip
       root * D:/domalecs-os/clix5/OSbench

       @static {
           file
           not path *.php
       }
       handle @static {
           file_server
       }

       @php_exists {
           path *.php
           file
       }
       handle @php_exists {
           reverse_proxy 127.0.0.1:8000
       }

       @not_static {
           not file
       }
       handle @not_static {
           rewrite * /index.php
           reverse_proxy 127.0.0.1:8000
       }

       header {
           Strict-Transport-Security "max-age=31536000; includeSubDomains"
           Cross-Origin-Opener-Policy same-origin
           Cross-Origin-Embedder-Policy require-corp
       }
   }
   ```

4. Run Caddy:

   ```powershell
   caddy run --config .\Caddyfile --adapter caddyfile
   ```

5. Browse: `https://dev.local/`

Stop: press **Ctrl+C** in the Caddy/Php terminals.

---

## Clean up

* Stop services:

  ```powershell
  .\run-https-dev.ps1 -Stop
  ```
* Remove host mapping (optional):

  * Edit `C:\Windows\System32\drivers\etc\hosts` and remove `dev.local` lines.
* Delete logs if you want: `https-dev-logs\*`

---

## Notes for production (later)

* Use a **real domain** and public TLS (Caddy + Let’s Encrypt).
* Set `APP_ENV=production`, `APP_DEBUG=0`, remove `APP_CSP_ALLOW_INLINE_DEV`.
* Keep `security_bootstrap.php` – it already enforces:

  * **HTTPS redirects**, **HSTS** (optionally `; preload`)
  * **CSP with nonces** (no inline by default)
  * Secure cookies/session settings
  * Hardening headers (X-Frame-Options, Referrer-Policy, etc)

---

Happy hacking! If you hit any rough edges, grab the relevant log from `https-dev-logs\` and re-run with the `-Start` flags you used; the script is idempotent and safe to re-run.
